{% extends 'layouts/base.html' %}

{% block title %}Template List{% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <!-- Header -->
    <div class="header bg-primary">
        <div class="container-fluid">
            <div class="header-body">
                <div class="row align-items-center py-4">
                    <div class="col-lg-6 col-7">
                        <h6 class="h2 text-white d-inline-block mb-0">Add Attributes</h6>
                        <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                                <li class="breadcrumb-item">
                                    <a href="/"><i class="fas fa-home"></i></a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="{% url "template_list" %}">Cheque Templates</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="{% url 'template_detail' template.id %}">Template Details</a>
                                </li>
                                  <li class="breadcrumb-item active" aria-current="page">Add Attributes</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- Main Content -->
<div class="container-fluid mt-4">
  
  <!-- Card for the Form -->
  <div class="card mt-3">
    <div class="card-body">
      
      <h1 class="text-primary">Template - {{ template.name }}</h1><br>

    <div style="position: relative; display: inline-block;">
        <img id="chequeTemplate" src="{{ template.background_image.url }}" 
             style="width: {{ template.width }}mm; height: {{ template.height }}mm; position: relative;">
    

        <!-- Render each text on the cheque at its specific position -->
        {% for text in previous_texts %}
        <div style="position: absolute; left: {{ text.x_position }}mm; top: {{ text.y_position }}mm;">
            {{ text.text }}
        </div>
        {% endfor %}
    </div>
          
    <div class="mt-3"> 
        <h1 class="text-primary">Text Box</h1>
    
        <!-- Draggable text div -->
        <div id="textBox" contenteditable="True" class="border border-dark position-absolute" style="cursor: move;">
           Set Text 
        </div>
        <br><br>
    
        <small class="text-muted">*Hold and drag the text box on the template to set the text position on it.</small>
    </div>
    <br>
    
    <!-- Form to Submit Text Data -->
    <form method="post" id="chequeTextForm">
        {% csrf_token %}
        <div class="form-group row mb-2">
            <label for="text" class="col-sm-2 col-form-label text-primary mb-0">
                <b>Text Attribute</b>
            </label>
            <input type="text" class="form-control w-75 col-sm-4" id="text" name="text" required>
            
        </div>
        <input type="hidden" name="x_position" id="x_position">
        <input type="hidden" name="y_position" id="y_position">
        <button type="submit" class="btn btn-primary mt-2">Add Text</button>
    </form>
    

<script>
    let textBox = document.getElementById("textBox");
    let chequeTemplate = document.getElementById("chequeTemplate");
    
    let offsetX, offsetY;

    textBox.onmousedown = function(event) {
        // Get initial cursor position relative to textBox
        offsetX = event.clientX - textBox.offsetLeft;
        offsetY = event.clientY - textBox.offsetTop;

        document.onmousemove = function(event) {
            // Set new position of textBox while dragging
            textBox.style.left = (event.clientX - offsetX) + 'px';
            textBox.style.top = (event.clientY - offsetY) + 'px';
        };

        document.onmouseup = function() {
            // Stop moving and set the final position values in the hidden form fields
            document.onmousemove = null;
            document.onmouseup = null;

            let chequeRect = chequeTemplate.getBoundingClientRect();
            let textRect = textBox.getBoundingClientRect();

            // Calculate relative X and Y positions in millimeters
            let xPosition = ((textRect.left - chequeRect.left) / chequeRect.width) * {{ template.width }};
            let yPosition = ((textRect.top - chequeRect.top) / chequeRect.height) * {{ template.height }};

            // Set values in form
            document.getElementById('x_position').value = xPosition.toFixed(2);
            document.getElementById('y_position').value = yPosition.toFixed(2);
        };
    };
</script>

  <div class="mt-6">
    <a class="btn btn-danger" href="{% url 'template_detail' template.id %}">Cancel</a>
</div>
      
    </div>
    <!-- card-body -->
  </div>
  <!-- Card -->
</div>
<!-- container-fluid -->

    <!-- Footer -->
    <div class="container-fluid mt-6">
        {% include "includes/footer.html" %}
    </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}
    <script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
    <script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>
{% endblock javascripts %}
