{% extends 'layouts/base.html' %}
{% load i18n %} 
{% load l10n %} 
{% load static %}

{% block tiitle %}{% trans "Set Text Position" %}{% endblock tiitle %}

{% block stylesheet %}

<style>
    .draggable {
        cursor: grab;
        display: inline-block;
        user-select: none;
        border-radius: 4px;
        min-width: max-content; /* Set width according to text */
    }

    .draggable:active {
        cursor: grabbing;
    }
</style>


{% endblock stylesheet %}

{% block content %}

<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    {% trans "Set Text Position" %}
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{% trans "Template Name" %} - {{ template.name }}</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Left column: Cheque template -->
                    <div class="col-md-9 border rounded p-3">

                        <div class = "mb-4">
                        <button type="submit" form = "chequeTextForm" class="btn btn-primary mt-2">{% trans "Save Positions" %}</button>
                        <button type="button" onclick="window.location='{% url 'template_detail' template.id %}';" class="btn btn-danger mt-2">{% trans "Cancel" %}</button>
                        </div>

                        <div id="toolbar" style="margin-bottom: 10px;">
                            <select id="fontFamily">
                                <option value="Arial">Arial</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Verdana">Verdana</option>
                            </select>
                        
                            <select id="fontSize">
                                <option value="12px">12</option>
                                <option value="14px">14</option>
                                <option value="16px">16</option>
                                <option value="18px">18</option>
                            </select>
                        
                            <button id="boldBtn"><b>B</b></button>
                            <button id="italicBtn"><i>I</i></button>
                        </div>
                        
                        
                        <form method="post" id="chequeTextForm">
                            {% csrf_token %}

                            <div id="chequeTemplate" style="position: relative; display: inline-block; background-image: url('{{ template.background_image.url }}'); background-size: contain; background-repeat: no-repeat; width: {{ template.width|unlocalize }}mm; height: {{ template.height|unlocalize }}mm;">

                                <!-- Draggable elements -->
                                {% if text.date_x_position and text.date_y_position %}
                                <div id="dateDiv" contenteditable="false" class="draggable border border-dark text-primary"
                                    style="position: absolute; left: {{ text.date_x_position|unlocalize }}mm; top: {{ text.date_y_position|unlocalize }}mm;">
                                    <span style="display: inline-block; width: 4mm;">{% trans "D" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "D" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "M" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "M" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                    <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                </div>
                                {% endif %}

                                {% if text.payee_x_position and text.payee_y_position %}
                                <div id="payeeDiv" contenteditable="false" class="draggable border border-dark text-primary"
                                    style="position: absolute; left: {{ text.payee_x_position|unlocalize }}mm; top: {{ text.payee_y_position|unlocalize }}mm;">
                                    {% trans "Payee" %}
                                </div>
                                {% endif %}

                                {% if text.amtwrds_x_position and text.amtwrds_y_position %}
                                <div id="amtWordsDiv" contenteditable="false" class="draggable border border-dark text-primary"
                                    style="position: absolute; left: {{ text.amtwrds_x_position|unlocalize }}mm; top: {{ text.amtwrds_y_position|unlocalize }}mm;">
                                    {% trans "Amount In Words" %}
                                </div>
                                {% endif %}

                                {% if text.amtnum_x_position and text.amtnum_y_position %}
                                <div id="amtNumDiv" contenteditable="false" class="draggable border border-dark text-primary"
                                    style="position: absolute; left: {{ text.amtnum_x_position|unlocalize }}mm; top: {{ text.amtnum_y_position|unlocalize }}mm;">
                                    {% trans "Amount" %}
                                </div>
                                {% endif %}

                                {% if text.sign_x_position and text.sign_y_position %}
                                <div id="signDiv" contenteditable="false" class="draggable border border-dark text-primary"
                                    style="position: absolute; left: {{ text.sign_x_position|unlocalize }}mm; top: {{ text.sign_y_position|unlocalize }}mm;">
                                    {% trans "Signature" %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Hidden fields to store positions -->
                            <input type="hidden" name="date_x_position" id="date_x_position"
                                value="{{ text.date_x_position}}">
                            <input type="hidden" name="date_y_position" id="date_y_position"
                                value="{{ text.date_y_position}}">
                            <input type="hidden" name="payee_x_position" id="payee_x_position"
                                value="{{ text.payee_x_position}}">
                            <input type="hidden" name="payee_y_position" id="payee_y_position"
                                value="{{ text.payee_y_position}}">
                            <input type="hidden" name="amtwrds_x_position" id="amtWords_x_position"
                                value="{{ text.amtwrds_x_position}}">
                            <input type="hidden" name="amtwrds_y_position" id="amtWords_y_position"
                                value="{{ text.amtwrds_y_position}}">
                            <input type="hidden" name="amtnum_x_position" id="amtNum_x_position"
                                value="{{ text.amtnum_x_position}}">
                            <input type="hidden" name="amtnum_y_position" id="amtNum_y_position"
                                value="{{ text.amtnum_y_position}}">
                            <input type="hidden" name="sign_x_position" id="sign_x_position"
                                value="{{ text.sign_x_position}}">
                            <input type="hidden" name="sign_y_position" id="sign_y_position"
                                value="{{ text.sign_y_position}}">


                        </form>
                    </div>

                    <!-- Right column: Toolbar -->
                    <div class="col-md-3 border rounded p-3">
                        <div id="toolbar">
                            <p class="text-muted">{% trans "Drag elements onto the cheque" %}</p>
                             <!-- Draggable elements in the toolbar -->
                             {% if not text.date_x_position or not text.date_y_position %}
                             <div id="dateDiv" contenteditable="false" class="draggable border border-dark text-primary mb-2">
                                 <span style="display: inline-block; width: 4mm;">{% trans "D" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "D" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "M" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "M" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                                 <span style="display: inline-block; width: 4mm;">{% trans "Y" %}</span>
                             </div>
                             {% endif %}
         
                             {% if not text.payee_x_position or not text.payee_y_position %}
                             <div id="payeeDiv" contenteditable="false" class="draggable border border-dark text-primary mb-2">
                                 {% trans "Payee" %}
                             </div>
                             {% endif %}
         
                             {% if not text.amtwrds_x_position or not text.amtwrds_y_position %}
                             <div id="amtWordsDiv" contenteditable="false" class="draggable border border-dark text-primary mb-2">
                                 {% trans "Amount In Words" %}
                             </div>
                             {% endif %}
         
                             {% if not text.amtnum_x_position or not text.amtnum_y_position %}
                             <div id="amtNumDiv" contenteditable="false" class="draggable border border-dark text-primary mb-2">
                                 {% trans "Amount" %}
                             </div>
                             {% endif %}
         
                             {% if not text.sign_x_position or not text.sign_y_position %}
                             <div id="signDiv" contenteditable="false" class="draggable border border-dark text-primary mb-2">
                                 {% trans "Signature" %}
                             </div>
                             {% endif %}
                        </div>
                    </div>
                </div> <!-- End row -->
            </div>
        </div>
    </div>
</div>


{% endblock content %}



{% block scripts %}



<script>

    document.addEventListener("DOMContentLoaded", function () {
        const chequeTemplate = document.getElementById("chequeTemplate");
    
        function makeDraggable(elementId, inputX, inputY) {
            const element = document.getElementById(elementId);
            const inputXField = document.getElementById(inputX);
            const inputYField = document.getElementById(inputY);
    
            let isDragging = false, offsetX = 0, offsetY = 0;
    
            if (!element || !chequeTemplate) return; // Prevent errors if elements are missing
    
            // Restore saved position only if inside chequeTemplate
            if (chequeTemplate.contains(element)) {
                if (localStorage.getItem(elementId + "_left")) {
                    element.style.left = localStorage.getItem(elementId + "_left");
                }
                if (localStorage.getItem(elementId + "_top")) {
                    element.style.top = localStorage.getItem(elementId + "_top");
                }
            }
    
            element.addEventListener("mousedown", (e) => {
                if (!chequeTemplate.contains(element)) return; // Ignore elements outside chequeTemplate
    
                isDragging = true;
                offsetX = e.clientX - element.getBoundingClientRect().left;
                offsetY = e.clientY - element.getBoundingClientRect().top;
                element.style.cursor = "grabbing";
            });
    
            document.addEventListener("mousemove", (e) => {
                if (!isDragging) return;
    
                const parent = chequeTemplate.getBoundingClientRect();
    
                let left = e.clientX - parent.left - offsetX;
                let top = e.clientY - parent.top - offsetY;
    
                // Prevent dragging outside chequeTemplate
                left = Math.max(0, Math.min(left, parent.width - element.offsetWidth));
                top = Math.max(0, Math.min(top, parent.height - element.offsetHeight));
    
                element.style.left = left + "px";
                element.style.top = top + "px";
    
                // Convert pixel values to mm
                const widthRatio = parent.width / parseFloat("{{ template.width|unlocalize }}");
                const heightRatio = parent.height / parseFloat("{{ template.height|unlocalize }}");
    
                let leftMM = (left / widthRatio).toFixed(2);
                let topMM = (top / heightRatio).toFixed(2);
    
                // Update hidden input fields only for elements inside chequeTemplate
                if (chequeTemplate.contains(element)) {
                    inputXField.value = leftMM;
                    inputYField.value = topMM;
                    localStorage.setItem(elementId + "_left", left + "px");
                    localStorage.setItem(elementId + "_top", top + "px");
                }
            });
    
            document.addEventListener("mouseup", () => {
                isDragging = false;
                element.style.cursor = "grab";
            });
        }
    
        // Apply the function to draggable elements inside chequeTemplate
        makeDraggable("dateDiv", "date_x_position", "date_y_position");
        makeDraggable("payeeDiv", "payee_x_position", "payee_y_position");
        makeDraggable("amtWordsDiv", "amtwrds_x_position", "amtwrds_y_position");
        makeDraggable("amtNumDiv", "amtnum_x_position", "amtnum_y_position");
        makeDraggable("signDiv", "sign_x_position", "sign_y_position");
    
        document.getElementById("chequeTextForm").addEventListener("submit", function () {
            localStorage.clear();
        });
    
        // Drag and Drop Functionality for Toolbar Elements
        document.querySelectorAll(".draggable").forEach((el) => {
            el.setAttribute("draggable", true);
            el.addEventListener("dragstart", function (e) {
                e.dataTransfer.setData("text/plain", el.id);
    
                // Capture the offset of the mouse within the element
                const rect = el.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;
    
                e.dataTransfer.setData("offsetX", offsetX);
                e.dataTransfer.setData("offsetY", offsetY);
    
                console.log(`Dragging: ${el.id}, OffsetX: ${offsetX}, OffsetY: ${offsetY}`);
            });
        });
    
        chequeTemplate.addEventListener("dragover", function (e) {
            e.preventDefault(); // Allow drop
        });
    
        chequeTemplate.addEventListener("drop", function (e) {
            e.preventDefault();
    
            const elementId = e.dataTransfer.getData("text/plain");
            const draggedElement = document.getElementById(elementId);
    
            if (draggedElement) {
                // Get the offset values
                const offsetX = parseFloat(e.dataTransfer.getData("offsetX")) || 0;
                const offsetY = parseFloat(e.dataTransfer.getData("offsetY")) || 0;
                console.log(`Dropped: ${elementId}, OffsetX: ${offsetX}, OffsetY: ${offsetY}`);
    
                const parentRect = chequeTemplate.getBoundingClientRect();
                let left = e.clientX - parentRect.left - offsetX;
                let top = e.clientY - parentRect.top - offsetY;
    
                // Prevent dragging outside
                left = Math.max(0, Math.min(left, parentRect.width - draggedElement.offsetWidth));
                top = Math.max(0, Math.min(top, parentRect.height - draggedElement.offsetHeight));
    
                draggedElement.style.position = "absolute";
                draggedElement.style.left = left + "px";
                draggedElement.style.top = top + "px";
    
                // Append to chequeTemplate if it's not already inside
                if (!chequeTemplate.contains(draggedElement)) {
                    chequeTemplate.appendChild(draggedElement);
                }
    
                // Convert to mm
                const widthRatio = parentRect.width / parseFloat("{{ template.width|unlocalize }}");
                const heightRatio = parentRect.height / parseFloat("{{ template.height|unlocalize }}");
    
                let leftMM = (left / widthRatio).toFixed(2);
                let topMM = (top / heightRatio).toFixed(2);
    
                // Update hidden input fields immediately on first drop
                let inputXField = document.getElementById(elementId.replace("Div", "") + "_x_position");
                let inputYField = document.getElementById(elementId.replace("Div", "") + "_y_position");

                
                console.log(`fields - ${inputXField} and ${inputYField} `);
    
                if (inputXField && inputYField) {
                    inputXField.value = leftMM;
                    inputYField.value = topMM;
                    console.log(`Updated Position on Drop - ${elementId}: X = ${leftMM}mm, Y = ${topMM}mm`);
                } else {
                    console.warn(`Hidden input fields not found for ${elementId}`);
                }
    
                // Ensure makeDraggable is applied so it works on future moves
                makeDraggable(elementId, elementId + "_x_position", elementId + "_y_position");
            }
        });
    });
    

</script>


{% endblock scripts %}