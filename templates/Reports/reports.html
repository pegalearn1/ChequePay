{% extends 'layouts/base.html' %}
{% load i18n %}
{% load static %}
{% block tiitle %}{% trans "Reports" %}{% endblock tiitle %}
{% block stylesheet %}

<style>
    /* Add spacing around the table */
    .table-responsive {
        padding: 15px;
    }
  
    /* Improve table spacing */
    table.dataTable {
        margin-top: 10px !important;
        border-spacing: 0 10px; /* Adds space between rows */
    }
  
    /* Center pagination */
    .dataTables_wrapper .dataTables_paginate {
        text-align: center !important;
        margin-top: 10px;
    }
  
    /* Table header styling */
    .dataTable thead th {
        background-color: #f8f9fa;
        padding: 12px;
        border-bottom: 2px solid #dee2e6;
    }
    
    /* Light gray row dividers */
    .dataTable tbody tr {
        border-bottom: 1px solid #e0e0e0 !important;
    }
    

  </style>
  

{% endblock stylesheet %}
{% block content %}

<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <h2 class="page-title">
            {% trans "Reports" %}
          </h2>
        </div>
    </div>
</div>

<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="row">
            <!-- Filters and Search Section -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Filters" %}</h4>
                    </div>
                    <div class="card-body">
                        <form method="post" id="report">
                            {% csrf_token %}
                            
                             <!-- Bank Filter -->
                             <div class="mb-3">
                                <label for="bankFilter">{% trans "Bank" %}</label>
                                <select class="form-control" name="bank" id="bankFilter">
                                    <option value="">{% trans "Select Bank" %}</option>
                                    {% for bankid, bankname in banks %}
                                    <option value="{{ bankid }}" {% if bankid == sel_bank %}selected{% endif %}>{{ bankname }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Approval Filter -->
                            <div class="mb-3">
                                <label for="approvalFilter">{% trans "Approval Status" %}</label>
                                <select class="form-control" name="approval" id="approvalFilter">
                                    <option value="">{% trans "Select Approval Status" %}</option>
                                    <option value="approved" {% if approval == 'approved' %}selected{% endif %}>{% trans "Approved" %}</option>
                                    <option value="pending" {% if approval == 'pending' %}selected{% endif %}>{% trans "Pending" %}</option>
                                    <option value="rejected" {% if approval == 'rejected' %}selected{% endif %}>{% trans "Rejected" %}</option>
                                </select>
                            </div>
                            
                            <!-- Date Range Filter -->
                            <div class="mb-3">
                                <label class="mb-2" for="start_date">{% trans "Cheque Date Range" %}</label>
                                <div class="mb-2">
                                    <label for="start_date">{% trans "From" %}</label>
                                    <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
                                </div>
                                <div>
                                    <label for="end_date">{% trans "To" %}</label>
                                    <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
                                </div>
                            </div>
                            
                            <!-- <div class="d-grid">
                                <button type="submit" class="btn btn-primary">{% trans "Apply Filters" %}</button>
                            </div> -->
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Tabs Section -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs" id="reportTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#payee-table">{% trans "Payee Report " %}</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#account-table">{% trans "Account Report" %}</a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="tab-content mt-3">
                        
                        <!-- payee-table -->
                        <div class="tab-pane fade show active" id="payee-table">

                            {% if payees %}
                            
                            <div style="margin-left: 10px;">
                                <button type="submit" form="payeeForm" class="btn btn-primary">{% trans "Generate Report" %}</button>
                                
                                <button type="button" class="btn btn-success" onclick="downloadReport('csv')">
                                    {% trans "Download CSV" %}
                                </button>
                                
                                <button type="button" class="btn btn-warning" onclick="downloadReport('xls')">
                                    {% trans "Download Excel" %}
                                </button>
                            </div>
                            
                            <script>
                                function downloadReport(format) {
                                    // Get the form element
                                    let form = document.getElementById('payeeForm');
                                    let formData = new FormData(form);
                                    let queryString = new URLSearchParams(formData).toString();
                            
                                    // Redirect with the form data as query parameters
                                    window.location.href = `{% url 'export_payee_report' '__FORMAT__' %}`.replace('__FORMAT__', format) + '?' + queryString;
                                }
                            </script>
                            
                            
                            <form method="post" id="payeeForm" action="{% url 'reports' %}" target="_blank">
                                {% csrf_token %}
                                
                                <!-- table -->
                                <div class="table-responsive">
                                    <table class="table card-table table-vcenter text-nowrap datatable" id="payeeDataTable">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" id="selectAllPayee"></th>
                                                <th>{% trans "Payee Name" %}</th>
                                                <th>{% trans "Mobile Number" %}</th>
                                                <th>{% trans "Email" %}</th>
                                                <th>{% trans "Address" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                {% for payee in payees %}
                                                <tr>
                                                    <td class="text-start">
                                                        <input type="checkbox" name="selected_payees" class="rowCheckboxPayee" value="{{ payee.issue_payee__id }}">
                                                    </td>
                                                    <td>{{ payee.issue_payee__payee_name }}</td>
                                                    <td>{{ payee.issue_payee__mobile_no }}</td>
                                                    <td>{{ payee.issue_payee__email }}</td>
                                                    <td>
                                                        {% if payee.address %}
                                                        {{ payee.issue_payee__address }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- table -->
                            </form>
                            {% else %}
                            <table class="table card-table table-vcenter text-nowrap datatable">
                                <tr>
                                    <td colspan="5" class="text-center">{% trans "No Payees found" %}</td>
                                </tr>
                            </table>
                            {% endif %}
                        </div>
                        <!-- payee-table -->

                        <!-- account-table -->
                        <div class="tab-pane fade show" id="account-table">

                            {% if accounts %}

                        <div style="margin-left: 10px;">

                            <button type="submit" form="accountForm" class="btn btn-success">{% trans "Generate Report" %}</button>

                        </div>

                            <form method="post" id="accountForm">
                                {% csrf_token %}
                                <!-- table -->
                                <div class="table-responsive" >
                                    <table class="table card-table table-vcenter text-nowrap datatable" id="accountDataTable">
                                    <thead>
                                        <tr>
                                        <th><input type="checkbox" id="selectAllAccount" action="{% url 'reports' %}"></th>
                                        <th>{% trans "Account Number" %}</th>
                                        <th>{% trans "Bank" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            {% for account, bank in accounts %}
                                        <tr>
                    
                                        <td class="text-start">
                                            <input type="checkbox" name="selected_accounts" value="{{account}}" class="rowCheckboxAccount">
                                        </td>
                                        
                                        <td>{{ account }}</td>
                                        <td>{{ bank }}</td>
                                        
                                        
                                        </tr>
                                        {% endfor %}
                                
                                    </tbody>
                                    </table>
                                </div>
                                <!-- table -->
                            </form>
                            {% else %}
                            <table class="table card-table table-vcenter text-nowrap datatable">
                                <tr>
                                    <td colspan="4" class="text-center">{% trans "No Accounts found" %}</td>
                                </tr>
                            </table>
                                {% endif %}
                        </div>
                        <!-- account-table -->

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function () {
    $(".nav-link").on("click", function () {
        $(".nav-link").removeClass("active");
        $(this).addClass("active");
    });
});


//for Payee table
//Initialize DataTable on page load
document.addEventListener('DOMContentLoaded', function () {
  $('#payeeDataTable').DataTable({
    paging: true, // Enable pagination
    pageLength: 10, // Number of rows per page
    lengthChange: true, // Allow changing number of rows per page
    searching: false, // Disable search (optional, if not needed)
    ordering: true, // Enable column sorting
    order: [], // Disable initial ordering
    info: true, // Show info about current page and total rows
    language: {
      paginate: {
        previous: "{% trans 'Previous' %}",
        next: "{% trans 'Next' %}",
      },
      info: "{% trans 'Showing _START_ to _END_ of _TOTAL_ entries' %}",
      lengthMenu: "{% trans 'Show _MENU_ entries' %}",
    },
  });
});

//for Account table
//Initialize DataTable on page load
document.addEventListener('DOMContentLoaded', function () {
  $('#accountDataTable').DataTable({
    paging: true, // Enable pagination
    pageLength: 10, // Number of rows per page
    lengthChange: true, // Allow changing number of rows per page
    searching: false, // Disable search (optional, if not needed)
    ordering: true, // Enable column sorting
    order: [], // Disable initial ordering
    info: true, // Show info about current page and total rows
    language: {
      paginate: {
        previous: "{% trans 'Previous' %}",
        next: "{% trans 'Next' %}",
      },
      info: "{% trans 'Showing _START_ to _END_ of _TOTAL_ entries' %}",
      lengthMenu: "{% trans 'Show _MENU_ entries' %}",
    },
  });
});



//for Payee table
document.addEventListener('DOMContentLoaded', function () {
    // Check if DataTable is already initialized
    if ($.fn.DataTable.isDataTable('#payeeDataTable')) {
        $('#payeeDataTable').DataTable().destroy();
    }

    var payeeTable = $('#payeeDataTable').DataTable({
        paging: true,
        pageLength: 10,
        lengthChange: true,
        searching: false,
        ordering: true,
        order: [],
        info: true,
        language: {
            paginate: {
                previous: "{% trans 'Previous' %}",
                next: "{% trans 'Next' %}",
            },
            info: "{% trans 'Showing _START_ to _END_ of _TOTAL_ entries' %}",
            lengthMenu: "{% trans 'Show _MENU_ entries' %}",
        },
        initComplete: function () {
            if (!$('#selectAllGlobalPayee').length) {
                $("#payeeDataTable_length").append(
                    '<label style="margin-left: 15px;">' +
                    '<input type="checkbox" id="selectAllGlobalPayee"> {% trans "Select All" %}' +
                    '</label>'
                );
            }
        }
    });

    // Select/Deselect All Rows on Current Page
    $('#selectAllPayee').on('click', function () {
        var isChecked = this.checked;
        $('.rowCheckboxPayee').prop('checked', isChecked);
    });

    // Select/Deselect All Rows Across All Pages
    $(document).on('click', '#selectAllGlobalPayee', function () {
        var isChecked = this.checked;
        $('.rowCheckboxPayee').prop('checked', isChecked);

        // Select all checkboxes across all pages using DataTables API
        payeeTable.rows().every(function () {
            $(this.node()).find('.rowCheckboxPayee').prop('checked', isChecked);
        });
    });

    // If any row checkbox is unchecked, uncheck the selectAll checkboxes
    $(document).on('click', '.rowCheckboxPayee', function () {
        if ($('.rowCheckboxPayee:checked').length === $('.rowCheckboxPayee').length) {
            $('#selectAllPayee').prop('checked', true);
            $('#selectAllGlobalPayee').prop('checked', true);
        } else {
            $('#selectAllPayee').prop('checked', false);
            $('#selectAllGlobalPayee').prop('checked', false);
        }
    });
});



//for Account table
$(document).ready(function () {
    // Check if DataTable is already initialized and destroy it before reinitializing
    if ($.fn.DataTable.isDataTable('#accountDataTable')) {
        $('#accountDataTable').DataTable().destroy();
    }

    var accountTable = $('#accountDataTable').DataTable({
        paging: true,
        pageLength: 10,
        lengthChange: true,
        searching: false,
        ordering: true,
        order: [],
        info: true,
        language: {
            paginate: {
                previous: "{% trans 'Previous' %}",
                next: "{% trans 'Next' %}",
            },
            info: "{% trans 'Showing _START_ to _END_ of _TOTAL_ entries' %}",
            lengthMenu: "{% trans 'Show _MENU_ entries' %}",
        },
        initComplete: function () {
            if (!$('#selectAllGlobalAccount').length) {
                $("#accountDataTable_length").append(
                    '<label style="margin-left: 15px;">' +
                    '<input type="checkbox" id="selectAllGlobalAccount"> {% trans "Select All" %}' +
                    '</label>'
                );
            }
        }
    });

    // Select/Deselect All Rows on Current Page
    $('#selectAllAccount').on('click', function () {
        var isChecked = this.checked;
        $('.rowCheckboxAccount').prop('checked', isChecked);
    });

    // Select/Deselect All Rows Across All Pages
    $(document).on('click', '#selectAllGlobalAccount', function () {
        var isChecked = this.checked;
        $('.rowCheckboxAccount').prop('checked', isChecked);

        // Select all checkboxes across all pages using DataTables API
        accountTable.rows().every(function () {
            $(this.node()).find('.rowCheckboxAccount').prop('checked', isChecked);
        });
    });

    // If any row checkbox is unchecked, uncheck the selectAll checkboxes
    $(document).on('click', '.rowCheckboxAccount', function () {
        if ($('.rowCheckboxAccount:checked').length === $('.rowCheckboxAccount').length) {
            $('#selectAllAccount').prop('checked', true);
            $('#selectAllGlobalAccount').prop('checked', true);
        } else {
            $('#selectAllAccount').prop('checked', false);
            $('#selectAllGlobalAccount').prop('checked', false);
        }
    });
});




    
    // to get the filter values and copy to other post forms
    document.addEventListener("DOMContentLoaded", function () {
    function copyFiltersToForm(targetFormId) {
        var filterForm = document.getElementById("report"); // Get filter form
        var targetForm = document.getElementById(targetFormId); // Get the target form (payeeForm or accountForm)

        // Remove existing hidden inputs (to avoid duplicates)
        targetForm.querySelectorAll(".filter-hidden-input").forEach(input => input.remove());

        // Copy all inputs from the filter form to the target form as hidden inputs
        filterForm.querySelectorAll("input, select").forEach(function (input) {
            if (input.name && input.value) {  // Ensure input has a name and value
                var hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = input.name;
                hiddenInput.value = input.value;
                hiddenInput.classList.add("filter-hidden-input");
                targetForm.appendChild(hiddenInput);
            }
        });

        targetForm.submit(); // Submit the selected form
    }

    // Attach event listeners to payee and account form buttons
    document.getElementById("payeeForm").addEventListener("submit", function (event) {
        event.preventDefault();
        copyFiltersToForm("payeeForm");
    });

    document.getElementById("accountForm").addEventListener("submit", function (event) {
        event.preventDefault();
        copyFiltersToForm("accountForm");
    });
});


</script>
{% endblock scripts %}
